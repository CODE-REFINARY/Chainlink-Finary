{% extends 'Patchwork/base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/generic.css' %}">
<script type="module" src="{% static 'scripts/chainlink-utilities.js' %}"></script>
<script type="module">

	import { addElement, makeForm, parseKeyUp, parseKeyDown, addButtonsDocView, addButtonsDocEmptyView, deleteDoc, deleteChainlink, deleteContent, renameDoc, editChainlink, editContent } from "{% static 'scripts/chainlink-utilities.js' %}";

	// await full DOM load before adding DB items
	document.addEventListener("DOMContentLoaded", function() {

		// Globals
		window.target = window.location.href;	// This is where AJAX requests should be sent
		window.ctrl = false;			// This flag inidicates whether the "ctrl" key is being held down

		var chainlinkDisplay = document.getElementById("chainlink-display");

		if (chainlinkDisplay.querySelector(":scope > section") == null) {
			window.in = "doc-empty";	// signal to key parser to disable all hotkeys except "c"
			addButtonsDocEmptyView();
		}

		else {
			window.in = "doc";
			addButtonsDocView();
		}

		// Add the event listeners above for keystrokes
		window.addEventListener("keyup", parseKeyUp);
		window.addEventListener("keydown", parseKeyDown);


		// Add event listeners for the "Options & Settings" section
		let deleteDocBtn = document.getElementById('doc-action-delete');

		deleteDocBtn.addEventListener("click", deleteDoc);

		const deleteClBtns = document.getElementsByClassName("cl-del-btn");
		const editClBtns = document.getElementsByClassName("cl-edit-btn");
		const deleteContBtns = document.getElementsByClassName("cont-del-btn");
		const editContBtns = document.getElementsByClassName("cont-edit-btn");

		const editDocBtn = document.getElementById('doc-action-edit-title');

		const numChainlinks = document.getElementsByClassName("chainlink").length;
		const numContents = document.getElementsByClassName("content-wrapper").length;

		for (let i = 0; i < numChainlinks; i++) {
			deleteClBtns[i].addEventListener("click", function() { deleteChainlink(deleteClBtns[i].getAttribute('target')) });
			editClBtns[i].addEventListener("click", function() { editChainlink(editClBtns[i].getAttribute('target')) });
		}

		for (let i = 0; i < deleteContBtns.length; i++) {
			deleteContBtns[i].addEventListener("click", function() { deleteContent(deleteContBtns[i].closest('.content-wrapper').id) });
		}

		for (let i = 0; i < editContBtns.length; i++) {
			editContBtns[i].addEventListener("click", function() { editContent(editContBtns[i].closest('.content-wrapper').id) });
		}

		editDocBtn.addEventListener("click", function() { renameDoc(); });
	});
</script>
<nav id="tabbed-buttons">
{% for doc in docs %}
	<button type="button" class="tabbed-buttons" onclick="window.location.href ='doc{{ doc.url }}.html'">{{ doc.title }}</button>
{% endfor %}
	<button type="button" id="add-page-btn" class="tabbed-buttons" onclick="window.location.href ='generate.html'">+</button>
</nav>
<div id="doc-title-wrapper">
	<h1 id="doc-title">{{ document.title|linebreaksbr }}</h1>
</div>
<div id="config-display">
<ul id="keybindings-legend">
	<h2>Keybindings Legend</h2>
	<li>j - scroll down</li>
	<li>k - scroll up</li>
	<li>n - create chainlink</li>
	<li>p - create text element</li>
	<li>h - create header element</li>
	<li>c - create code block</li>
	<li>b - insert linebreak</li>
</ul>
<ul id="chainlink-manifest">
	<h2>Chainlink Manifest</h2>
	{% if chainlinks %}
	{% for chainlink in chainlinks %}
	<li><a class="inline-url" href="#{{ chainlink.url }}">>>>{{ chainlink.title }}</a></li>
	{% endfor %}
	{% else %}
	<li><i>&#60;list empty&#62;</i></li>
	{% endif %}
</ul>
<ul id="options-settings">
	<h2>Options & Settings</h2>
	<li><button id="doc-action-copy-link">Copy link to this doc</button></li>
	<li><button id="doc-action-change-theme">Change theme</button></li>
	<li><button id="doc-action-find-references">Find references</button></li>
	<li><button id="doc-action-edit-title">Rename doc</button></li>
	<li><button id="doc-action-delete">Delete this doc</button></li>
</ul>
</div>
<div id="decoration-display"><pre> 
      ___           ___           ___           ___           ___           ___           ___                       ___           ___     
     /\  \         /\  \         /\  \         /\__\         /\  \         /\  \         /\  \          ___        /\  \         /\  \    
     \:\  \       /::\  \       /::\  \       /::|  |       /::\  \       /::\  \       /::\  \        /\  \      /::\  \        \:\  \   
      \:\  \     /:/\:\  \     /:/\:\  \     /:|:|  |      /:/\ \  \     /:/\:\  \     /:/\:\  \       \:\  \    /:/\:\  \        \:\  \  
      /::\  \   /::\~\:\  \   /::\~\:\  \   /:/|:|  |__   _\:\~\ \  \   /:/  \:\  \   /::\~\:\  \      /::\__\  /::\~\:\  \       /::\  \ 
     /:/\:\__\ /:/\:\ \:\__\ /:/\:\ \:\__\ /:/ |:| /\__\ /\ \:\ \ \__\ /:/__/ \:\__\ /:/\:\ \:\__\  __/:/\/__/ /:/\:\ \:\__\     /:/\:\__\
    /:/  \/__/ \/_|::\/:/  / \/__\:\/:/  / \/__|:|/:/  / \:\ \:\ \/__/ \:\  \  \/__/ \/_|::\/:/  / /\/:/  /    \/__\:\/:/  /    /:/  \/__/
   /:/  /         |:|::/  /       \::/  /      |:/:/  /   \:\ \:\__\    \:\  \          |:|::/  /  \::/__/          \::/  /    /:/  /     
   \/__/          |:|\/__/        /:/  /       |::/  /     \:\/:/  /     \:\  \         |:|\/__/    \:\__\           \/__/     \/__/      
                  |:|  |         /:/  /        /:/  /       \::/  /       \:\__\        |:|  |       \/__/                                
                   \|__|         \/__/         \/__/         \/__/         \/__/         \|__|                                            

</pre></div>
<div id="chainlink-display">
{% for content in contents %}
		{% if content.tag == 'header2' %}
		<section class="chainlink">
			<div id="{{ content.url }}" class="chainlink-wrapper">
				<h2>{{ content.title }}</h2>
				<a class="inline-url header-url" href="chainlink{{ content.url }}.html">>>>{{ content.url|slice:"0:9" }}</a>
				<button target="{{ content.url }}" class="cl-edit-btn">edit</button>
				<button target="{{ content.url }}" class="cl-del-btn">delete</button>
			</div>
		{% elif content.tag == 'paragraph' %}
		<div id="{{ content.url }}-{{ content.order }}" class="content-wrapper">
			<p>{{ content.content }}</p>	
			<button class="cont-edit-btn">edit</button>
			<button class="cont-del-btn">delete</button>
			
		</div>
		{% elif content.tag == 'code' %}
		<div id="{{ content.url }}-{{ content.order }}" class="content-wrapper">
			<code>{{ content.content }}</code>
			<button class="cont-edit-btn">edit</button>
			<button class="cont-del-btn">delete</button>
			
		</div>
		{% elif content.tag == 'header3' %}
		<div id="{{ content.url }}-{{ content.order }}" class="content-wrapper">
			<h3>
				<div class="h3">{{ content.content }}</div>
			</h3>	
			<button class="cont-edit-btn">edit</button>
			<button class="cont-del-btn">delete</button>
		</div>
		{% elif content.tag == 'linebreak' %}
		<div id="{{ content.url }}-{{ content.order }}" class="content-wrapper">
			<span class="br"></span>
			<button class="cont-edit-btn">edit</button>
			<button class="cont-del-btn">delete</button>
		</div>
			{% elif content.tag == 'delimiter' %}
		</section>
		{% endif %}
{% endfor %}
{% endblock %}
</div>
